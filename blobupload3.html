<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BLOB upload</title>
</head>
<style>
    progress {
        display: block;
    }
</style>
<body>
    <form action="#">
        <input type="file" value="" id="file" name="file" multiple><br>
        <input type="submit" id="uploadBtn" value="UPLOAD"><br>
        <div id="progressBars"></div>
        <div id="errorMessage" style="color: red;"></div>
    </form>
</body>
<script>
    const uploadBtn = document.querySelector('#uploadBtn')
    const url = 'http://clone-weetransfert.test/blobupload.php'
    const progressBarsContainer = document.querySelector('#progressBars')
    const errorMessage = document.querySelector('#errorMessage')

    uploadBtn.addEventListener('click', function (e) {
        e.preventDefault()
        const files = document.querySelector('#file').files
        progressBarsContainer.innerHTML = '' // Nettoyer les progress bars
        const uploadId = generateUID() // Générer un ID unique pour chaque upload
        for (const file of files) {
            const fileContainer = document.createElement('div')
            const fileName = document.createElement('span')
            fileName.textContent = file.name
            const progressBar = document.createElement('progress')
            progressBar.value = 0
            progressBar.max = 100
            fileContainer.appendChild(fileName)
            fileContainer.appendChild(progressBar)
            progressBarsContainer.appendChild(fileContainer)
            uploadBlob(file, progressBar, uploadId)
        }
    })

    async function uploadBlob(file, progressBar, uploadId) {
        const chunkSize = 100_000;
        const totalChunks = Math.ceil(file.size / chunkSize)
        for (let i = 0, start = 0; start < file.size; start += chunkSize, i++) {
            let end = start + chunkSize
            const chunk = file.slice(start, end)
            try {
                const response = await fetch(url, {
                    method: "POST",
                    headers: {
                        'Content-Disposition': `attachment; filename="${file.name}"`,
                        'Upload-ID': uploadId, // ID unique pour chaque upload
                        'Total-Chunks': totalChunks // Nombre total de chunks
                    },
                    body: chunk
                })
                if (response.status !== 200) {
                    throw new Error('Erreur lors de l\'upload')
                }
                progressBar.value = ((i + 1) / totalChunks) * 100
            } catch (error) {
                errorMessage.textContent = 'Erreur lors de l\'upload : ' + error.message
                break
            }
        }
        // Nous avons fini d'envoyer les chunks, on finalise l'upload
        try {
            const response = await fetch(url, {
                method: "POST",
                headers: {
                    'Content-Disposition': `attachment; filename="${file.name}"`,
                    'Upload-ID': uploadId,
                    'Upload-Complete': 'true'
                }
            })
            if (response.status !== 200) {
                throw new Error('Erreur lors de la finalisation de l\'upload')
            }
            progressBar.value = 100
        } catch (error) {
            errorMessage.textContent = 'Erreur lors de la finalisation de l\'upload : ' + error.message
        }
    }

    function generateUID() {
        // Création d'un id unique pour chaque upload avec un timestamp et un nombre aléatoire
        return Date.now() + '-' + Math.random().toString(36).substr(2, 9);
    }
</script>
</html>
